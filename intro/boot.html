<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Порядок загрузки | Разработка ОС</title>
    <meta name="generator" content="VuePress 1.9.5">
    
    <meta name="description" content="osdev.org на русском">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/osdev/assets/css/0.styles.cf6cd58c.css" as="style"><link rel="preload" href="/osdev/assets/js/app.6d4e7c16.js" as="script"><link rel="preload" href="/osdev/assets/js/2.d8a8b755.js" as="script"><link rel="preload" href="/osdev/assets/js/11.62d004c8.js" as="script"><link rel="prefetch" href="/osdev/assets/js/10.f52dfc28.js"><link rel="prefetch" href="/osdev/assets/js/12.de6a66d3.js"><link rel="prefetch" href="/osdev/assets/js/13.5ce18855.js"><link rel="prefetch" href="/osdev/assets/js/14.2418957f.js"><link rel="prefetch" href="/osdev/assets/js/15.c118d926.js"><link rel="prefetch" href="/osdev/assets/js/16.d7ace87c.js"><link rel="prefetch" href="/osdev/assets/js/17.ed033aaf.js"><link rel="prefetch" href="/osdev/assets/js/18.fd5dcd0e.js"><link rel="prefetch" href="/osdev/assets/js/19.401c7b19.js"><link rel="prefetch" href="/osdev/assets/js/20.69a7aab0.js"><link rel="prefetch" href="/osdev/assets/js/21.aa99a090.js"><link rel="prefetch" href="/osdev/assets/js/22.21e5a0d1.js"><link rel="prefetch" href="/osdev/assets/js/23.25b4c5a4.js"><link rel="prefetch" href="/osdev/assets/js/24.e3d90789.js"><link rel="prefetch" href="/osdev/assets/js/25.f01e693e.js"><link rel="prefetch" href="/osdev/assets/js/3.9d834bc1.js"><link rel="prefetch" href="/osdev/assets/js/4.15995e12.js"><link rel="prefetch" href="/osdev/assets/js/5.3392b390.js"><link rel="prefetch" href="/osdev/assets/js/6.a16b59c6.js"><link rel="prefetch" href="/osdev/assets/js/7.5089196a.js"><link rel="prefetch" href="/osdev/assets/js/8.83af78e0.js"><link rel="prefetch" href="/osdev/assets/js/9.f2730610.js">
    <link rel="stylesheet" href="/osdev/assets/css/0.styles.cf6cd58c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/osdev/" class="home-link router-link-active"><!----> <span class="site-name">Разработка ОС</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/osdev/intro/" class="nav-link router-link-active">
  Введение
</a></div><div class="nav-item"><a href="/osdev/teapot/" class="nav-link">
  Гайд для чайников
</a></div><div class="nav-item"><a href="/osdev/hardware/" class="nav-link">
  Аппаратная часть
</a></div><div class="nav-item"><a href="/osdev/os/" class="nav-link">
  Конструкция ОС
</a></div><div class="nav-item"><a href="/osdev/resources/" class="nav-link">
  Ресурсы
</a></div><div class="nav-item"><a href="/osdev/reference/" class="nav-link">
  Справочная информация
</a></div><div class="nav-item"><a href="/osdev/tools/" class="nav-link">
  Утилиты
</a></div><div class="nav-item"><a href="https://wiki.osdev.org/Main_Page" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Оригинал
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/mayerdev/osdev" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/mayerdev/osdev" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/osdev/intro/" class="nav-link router-link-active">
  Введение
</a></div><div class="nav-item"><a href="/osdev/teapot/" class="nav-link">
  Гайд для чайников
</a></div><div class="nav-item"><a href="/osdev/hardware/" class="nav-link">
  Аппаратная часть
</a></div><div class="nav-item"><a href="/osdev/os/" class="nav-link">
  Конструкция ОС
</a></div><div class="nav-item"><a href="/osdev/resources/" class="nav-link">
  Ресурсы
</a></div><div class="nav-item"><a href="/osdev/reference/" class="nav-link">
  Справочная информация
</a></div><div class="nav-item"><a href="/osdev/tools/" class="nav-link">
  Утилиты
</a></div><div class="nav-item"><a href="https://wiki.osdev.org/Main_Page" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Оригинал
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/mayerdev/osdev" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/mayerdev/osdev" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Введение</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/osdev/intro/" aria-current="page" class="sidebar-link">Главная</a></li><li><a href="/osdev/intro/required.html" class="sidebar-link">Необходимые знания</a></li><li><a href="/osdev/intro/mistakes.html" class="sidebar-link">Ошибки начинающих</a></li><li><a href="/osdev/intro/getting-started.html" class="sidebar-link">Начало работы</a></li><li><a href="/osdev/intro/kcl-linking.html" class="sidebar-link">Как ядро, компилятор и код на C работают вместе</a></li><li><a href="/osdev/intro/isr.html" class="sidebar-link">Обработка прерываний</a></li><li><a href="/osdev/intro/languages.html" class="sidebar-link">Языки программирования</a></li><li><a href="/osdev/intro/uefi.html" class="sidebar-link">UEFI</a></li><li><a href="/osdev/intro/bios.html" class="sidebar-link">BIOS</a></li><li><a href="/osdev/intro/inline-asm.html" class="sidebar-link">Встроенная сборка</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Первые шаги</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/osdev/first-steps/bare-bones.html" class="sidebar-link">Голое железо</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="порядок-загрузки"><a href="#порядок-загрузки" class="header-anchor">#</a> Порядок загрузки</h1> <h2 id="post"><a href="#post" class="header-anchor">#</a> POST</h2> <p>Когда компьютер включен или перезагружается, он проходит серию диагностических процедур, называемых <a href="https://ru.wikipedia.org/wiki/POST_(%D0%B0%D0%BF%D0%BF%D0%B0%D1%80%D0%B0%D1%82%D0%BD%D0%BE%D0%B5_%D0%BE%D0%B1%D0%B5%D1%81%D0%BF%D0%B5%D1%87%D0%B5%D0%BD%D0%B8%D0%B5)" target="_blank" rel="noopener noreferrer">POST - Power-On Self-Test<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Эта процедура завершается поиском загрузочного устройства, такого как дискета, компакт-диск или жесткий диск, в том порядке, который настроен в BIOS.</p> <h2 id="master-boot-record"><a href="#master-boot-record" class="header-anchor">#</a> Master Boot Record</h2> <p>Legacy-BIOS проверяет загрузочные устройства на наличие сигнатуры. Сигнатура загрузки находится в загрузочном секторе (номер сектора 0) и содержит последовательность байтов 0x55, 0xAA при смещениях байтов 510 и 511 соответственно. Когда BIOS находит такой загрузочный сектор, он загружается в память по адресу 0x0000:0x7c00 (сегмент 0, адрес 0x7c00). (Однако некоторые BIOS загружаются в 0x7c0:0x0000 (сегмент 0x07c0, смещение 0), что приводит к одному и тому же физическому адресу. Хорошей практикой является применение CS:IP в самом начале вашего загрузочного сектора.)</p> <p>Затем выполнение переносится в загрузочную запись. На гибком диске все 512 байтов загрузочной записи (за исключением последних двух байтов подписи) могут содержать исполняемый код. На жестком диске Главная загрузочная запись (MBR) содержит исполняемый код со смещением 0x0000 - 0x01bd, за которым следуют записи таблицы для четырех основных разделов, используя шестнадцать байт на запись (0x01be - 0x01fd) и двухбайтовую подпись (0x01fe - 0x01ff).</p> <h2 id="ранняя-среда"><a href="#ранняя-среда" class="header-anchor">#</a> Ранняя среда</h2> <p>Cреда раннего выполнения в значительной степени определяется реализацией вашего конкретного BIOS. Никогда не делайте никаких предположений относительно содержимого регистров: они могут быть инициализированы до 0, но они также могут содержать ложное значение. Это включает в себя регистр FLAGS и регистр SP, у вас также может не быть валидного стека! Единственное, в чем можно быть уверенным, так это в том, что регистр DL содержит код диска, с которого был загружен ваш загрузочный код.</p> <p>Процессор в настоящее время находится в реальном режиме. (Если только вы не работаете на одном из тех редких BIOS, которые считают, что делают вам одолжение, активируя для вас защищенный режим. Это означает, что вам нужно не только написать код для активации защищенного режима, но и добавить проверку на случай, если он уже активирован.).</p> <h2 id="ядро"><a href="#ядро" class="header-anchor">#</a> Ядро</h2> <p>Наконец, загрузчик загружает ядро в память и передает ему управление.</p> <h2 id="загрузка"><a href="#загрузка" class="header-anchor">#</a> Загрузка</h2> <p>Теперь мы знаем, что нам нужно загрузить, давайте посмотрим, как мы это загрузим.</p> <p>При загрузке с жесткого диска для загрузочной записи доступно только 446 байт. Взглянув на список дел, которые необходимо выполнить до запуска образа ядра, вы согласитесь, что это не так уж много:</p> <ul><li>определить, с какого раздела следует загрузиться (либо путем поиска активного раздела, либо путем предоставления пользователю выбора установленных операционных систем);</li> <li>определить, где находится ваш образ ядра в загрузочном разделе (либо путем интерпретации файловой системы, либо путем загрузки образа из фиксированного положения);</li> <li>загрузить образ ядра в память (требуется базовый дисковый I/O);</li> <li>включить защищенный режим;</li> <li>подготовка среды выполнения для ядра (например, настройка пространства стека);</li></ul> <p>Вам не нужно делать вещи в таком порядке, но все это должно быть сделано до того, как вы сможете вызвать kmain().</p> <p>Что еще хуже, GCC генерирует исполняемые файлы в защищенном режиме, поэтому код для этой ранней среды является одной из вещей, которые вы не можете сделать в C.</p> <p>Есть несколько решений этой проблемы:</p> <ul><li><strong>Geek-загрузка</strong>: Сожмите всё из приведенного выше списка в загрузочную запись. Это практически невозможно и не оставляет места для обработки особых случаев или полезных сообщений об ошибках.</li> <li><strong>Одноэтапная загрузка</strong>: написать программу-заглушку для создания коммутатора и связать её с образом ядра. Загрузочная запись загружает образ ядра (ниже отметки в 1 Мб памяти, потому что в реальном режиме это верхний предел памяти!), Переходит в заглушку, заглушка переключается в защищенный режим, готовится к выполнению и переходит в ядро.</li> <li><strong>Двухэтапная загрузка</strong>: напишите отдельную программу-заглушку, которая загружается ниже отметки в 1 Мб памяти и делает все из приведенного выше списка.</li></ul> <h3 id="традиционныи-способ"><a href="#традиционныи-способ" class="header-anchor">#</a> Традиционный способ</h3> <p>Традиционно MBR перемещается в 0x0000:0x0600, определяет активный раздел из таблицы разделов, загружает первый сектор этого раздела (&quot;загрузочная запись раздела&quot;) в 0x0000:0x7c00 (следовательно, предыдущее перемещение) и переходит к этому адресу. Это называется &quot;цепной загрузкой&quot;. Если вы хотите, чтобы записанная вами загрузочная запись была способна к двойной загрузке, например, Windows, она должна имитировать это поведение.</p> <h3 id="легкии-выход"><a href="#легкии-выход" class="header-anchor">#</a> Лёгкий выход</h3> <p>Если вы действительно не хотите использовать свой собственный загрузчик для образовательных целей, мы рекомендуем использовать легкодоступные загрузчики.</p> <p>Наиболее заметным из них является GRUB, двухступенчатый загрузчик, который не только предоставляет меню загрузки с возможностью загрузки по цепочке, но и инициализирует начальную среду до четко определенного состояния (включая защищенный режим и чтение различной интересной информации из BIOS), может загружать общие исполняемые файлы в виде образов ядра (вместо того, чтобы требовать двоичные файлы, как большинство других загрузчиков), поддерживает дополнительные модули ядра, различные файловые системы и, если ./configure сделан правильно, то даже бездисковую загрузку.</p> <h3 id="другие-способы"><a href="#другие-способы" class="header-anchor">#</a> Другие способы</h3> <p>Существует множество возможных вариантов загрузки. Ниже приведен список методов, но возможно, что существует еще больше методов:</p> <ul><li>Вы можете взять неиспользуемый раздел и загрузить двухэтапный &quot;raw&quot;</li> <li>Вы можете поместить этап 2 между MBR и началом первого раздела</li> <li>Вы можете написать файл ядра, а затем использовать инструмент для обнаружения секторов (или кластеров). Затем пусть этап 1 загрузит сектора из списка.</li> <li>Как это делает DOS и Windows: создайте пустую файловую систему (отформатируйте ее), а затем поместите ядро в первый файл, а оболочку во второй файл в пустой корневой каталог. Таким образом, загрузчик просто загружает первую запись в rootdir, а затем вторую.</li> <li>Старый Linux загружался с дискеты. Первый сектор (&quot;загрузка&quot;) загружал второй этап в режиме &quot;raw&quot; = без файловой системы (второй этап был &quot;настройка&quot;, в секторах непосредственно за &quot;загрузкой&quot;) На втором этапе была настройка системы (видеорежим, карта памяти и т.д.), А Затем загружался реальный образ ядра (упакованный в tgz/bz).</li></ul> <h2 id="внешние-ссылки"><a href="#внешние-ссылки" class="header-anchor">#</a> Внешние ссылки</h2> <ul><li><a href="https://manybutfinite.com/post/how-computers-boot-up/" target="_blank" rel="noopener noreferrer">Как включаются компьютеры<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://manybutfinite.com/post/kernel-boot-process/" target="_blank" rel="noopener noreferrer">Процесс запуска ядра<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.ibm.com/technologies/linux/articles/l-linuxboot/" target="_blank" rel="noopener noreferrer">Загрузка линукс изнутри<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/osdev/assets/js/app.6d4e7c16.js" defer></script><script src="/osdev/assets/js/2.d8a8b755.js" defer></script><script src="/osdev/assets/js/11.62d004c8.js" defer></script>
  </body>
</html>
