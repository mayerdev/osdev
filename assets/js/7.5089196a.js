(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{394:function(t,s,a){"use strict";a.r(s);var n=a(52),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"голое-железо"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#голое-железо"}},[t._v("#")]),t._v(" Голое железо")]),t._v(" "),a("p",[t._v("В этом туториале мы напишем простое 32х-битное ядро и загрузим его. Это первый шаг в создании вашей операционной системы. Здесь вы узнаете как создать минимальную систему, но не как нужно структурировать ваш проект.")]),t._v(" "),a("h2",{attrs:{id:"настроика-кросс-компилятора"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#настроика-кросс-компилятора"}},[t._v("#")]),t._v(" Настройка кросс-компилятора")]),t._v(" "),a("p",[t._v("Первым делом вам необходимо настроить GCC для i686-elf. Вы еще не модифицировали свой компилятор, чтобы дать ему знать о существовании вашей операционной системы, поэтому мы будем использовать стандартную сборку под i686-elf, который предоставляет инструменты для System V ABI.")]),t._v(" "),a("p",[t._v("Вы "),a("strong",[t._v("не сможете")]),t._v(" правильную сборку вашей ОС без кросс-компилятора.")]),t._v(" "),a("p",[t._v("Вы "),a("strong",[t._v("не сможете")]),t._v(" корректно завершить этот туториал с x86_64-elf, потому что GRUB способен загружать только 32х-битные "),a("a",{attrs:{href:"https://ru.wikipedia.org/wiki/%D0%9C%D1%83%D0%BB%D1%8C%D1%82%D0%B8%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0",target:"_blank",rel:"noopener noreferrer"}},[t._v("мультизагрузочные"),a("OutboundLink")],1),t._v(" ядра. Если это ваша первая ОС, то следует начать с 32х-битного ядра.")]),t._v(" "),a("h2",{attrs:{id:"обзор"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#обзор"}},[t._v("#")]),t._v(" Обзор")]),t._v(" "),a("p",[t._v("Теперь вам понадобится три входных файлов:")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("boot.s")]),t._v(" - точка входа ядра, которая настроит среду процессора,")]),t._v(" "),a("li",[a("code",[t._v("kernel.c")]),t._v(" - код вашего ядра,")]),t._v(" "),a("li",[a("code",[t._v("linker.ld")]),t._v(" - информация компоновки файлов выше.")])]),t._v(" "),a("h2",{attrs:{id:"загружаем-ядро-ос"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#загружаем-ядро-ос"}},[t._v("#")]),t._v(" Загружаем ядро ОС")]),t._v(" "),a("p",[t._v("Для запуска ОС необходимо иметь ПО, которое сможет загрузить её. Такое ПО называют "),a("em",[t._v("загрузчиками")]),t._v(", мы будем использовать GRUB. Ядро получает от загрузчика минимальную среду, в которой ещё не настроен стек, виртуальная память, подключенные устройства и так далее.")]),t._v(" "),a("p",[t._v("Чтобы сообщить загрузчику как загрузить ОС будем использовать стандарт мультизагрузки, который описывает простой интерфейс между загрузчиком и ядром. Это работает благодаря глобальным переменным, которые ищет загрузчик.")]),t._v(" "),a("p",[t._v("В этом примере используется ассемблер GNU, который является частью кросс-компилятора, настроенного ранее.")]),t._v(" "),a("div",{staticClass:"language-gs extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('/* Объявляем содержимое нашего заголовка. */\n.set ALIGN,    1<<0             /* выравнивать загруженные модули по границам страницы */\n.set MEMINFO,  1<<1             /* предоставлять карту памяти (memory map) */\n.set FLAGS,    ALIGN | MEMINFO  /* это поле "флаги" заголовка */\n.set MAGIC,    0x1BADB002       /* "волшебное" число, позволяющее загрузчику найти заголовок */\n.set CHECKSUM, -(MAGIC + FLAGS) /* контрольная сумма */\n\n/*\nОбъявление заголовка мультизагрузки помечает программу как ядро. Все эти\nзначения можно найти в стандарте. Загрузчик будет искать этот заголовок\nв первых 8 кБ файла ядра, с отступом до 32х-битной границы. Сигнатура может\nнаходиться в отдельной секции, поэтому заголовок может быть принудительно\nпомещен в начало файла.\n*/\n.section .multiboot\n.align 4\n.long MAGIC\n.long FLAGS\n.long CHECKSUM\n\n/*\nСтандарт мультизагрузочности не предусматривает установку значения регистра\nуказателя на стек (esp), т. е. стек должен предоставляться ядром. По стандарту\nпроисходит выделение (аллокация) памяти для малого стека путём создания символа\nв его конце, после происходит выделение 16384 байт для этого и создаётся символ\nв начале. На архитектуре x86 стек направлен вниз. Стек находится в отдельной секции,\nпоэтому его можно пометить как nobits, что означает меньший развер файла ядра,\nпоскольку он не содержит неинициализированного стека. Стек на x86 должен быть\nвыровнен до 16 байт в соответствии со стандартом System V ABI и фактическими\nрасширениями. Компилятор предполагает, что стек выровнен корректно, отсутствие\nвыравнивания может привести к неопределенному поведению.\n*/\n.section .bss\n.align 16\nstack_bottom:\n.skip 16384 # 16 KiB\nstack_top:\n\n/*\nСкрипт компоновщика указывает _start как точку входа ядра, и загрузчик перейдёт\nк этой метке сразу после полной загрузки ядра. Не важно, возвращает ли эта функция\nзначение, на данном этапе загрузчика уже нет.\n*/\n.section .text\n.global _start\n.type _start, @function\n_start:\n    /*\n    Загрузчик запускается в защищённом (protected) режиме на x86.\n    Прерывания (interrupts) не доступны, как и подкачка страниц памяти (memory paging).\n    В этот момоент ЦП находится в состоянии, указанном стандартом мультизагрузочности,\n    и под полным контролем ядра. Ядро может только использовать аппаратные функции, либо\n    собственный код. Здесь нет ни printf, ни ограничений безопасности, ни каких-либо\n    гарантий, ни механизма отладки - только то, что предоставляет само ядно.\n    */\n\n    /*\n    Чтобы "установить" стек сохраняем указатель на его начало в регистр `esp`.\n    Это необходимо сделать на ассемблере, потому что языки как C не могут\n    функционировать без стека.\n    */\n    mov $stack_top, %esp\n\n    /*\n    Это хорошее место для инициализации минимального состояния процессора до перехода\n    в высокоуровневое ядро. Лучше всего свести к минимуму раннюю среду, в которой важные\n    функции отключены. Помните, что процессор еще не полностью инициализирован: инструкции\n    с плавающей запятой и расширения набора инструкций, еще не доступны. Здесь должен быть\n    загружен GDT и включена подкачка страниц памяти. Функций C++, как глобальные конструкторы\n    и исключения, потребуют  поддержки среды выполнения для нормальной работы.\n    */\n\n    /*\n    Переход в высокоуровневое ядро. ABI требует, чтобы стек был выровнен по 16 байт во время\n    вызова инструкции (которая отдаёт 4х-байтный указатель). Изначально стек был выровнен,\n    и с тех пор мы поместили в стек несколько байтов, кратное 16 байтам (пока что 0 байт),\n    поэтому выравнивание было сохранено, и вызов четко определен.\n    */\n    call kernel_main\n\n    /*\n    Если системе больше нечего делать, то мы оставляем компьютер в бесконечном цикле.\n    Для этого мы:\n    1) Отключаем прерывания через cli (clear interrupt enable in eflags).\n       Они уже отключены загрузчиком, поэтому это необезательно.\n       Возможно, что позже вы захотите включить прерывания и вернуться из kernel_main\n       (что немного бессмысленно).\n    2) Ожидаем следующим прерываним инструкцию hlt (англ. halt - остановки/отключения).\n       Т. к. они выключены, это заблокирует компьютер.\n    3) Переходим на инструкцию hlt, если это вызвано не маскируемым прерыванием или\n       режимом управления системой.\n    */\n    cli\n1:\n    hlt\n    jmp 1b\n\n/*\nУстанавливаем размер символа _start, используя текущую позицию ("."), путём\nвычитания позиции метки этого символа. Это может быть полезно при отладке\nили реализации стека вызовов (call stack).\n*/\n.size _start, . - _start\n')])])]),a("p",[t._v("Теперь вы можете собрать "),a("code",[t._v("boot.s")]),t._v(", используя:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("i686-elf-as boot.s -o boot.o\n")])])]),a("h2",{attrs:{id:"реализация-ядра"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#реализация-ядра"}},[t._v("#")]),t._v(" Реализация ядра")]),t._v(" "),a("p",[t._v("После написания базового загрузчика можно использовать более высокоуровневые языки, например C/C++.")]),t._v(" "),a("h3",{attrs:{id:"отдельные-и-размещенные-среды"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#отдельные-и-размещенные-среды"}},[t._v("#")]),t._v(" Отдельные и размещённые среды")]),t._v(" "),a("p",[t._v("Если вы уже использовали C/C++ для пользовательских прогрмамм, то вы использовали так называемую резмещённую ("),a("em",[t._v("англ.")]),t._v(" hosted) среду, что означает наличие стандартной библиотеки языка и различных удобств, доступных во время выполнения ("),a("em",[t._v("англ.")]),t._v(" runtime). Также сущесвуют отдельные ("),a("em",[t._v("англ.")]),t._v(" freestanding) среды, которые мы и будем использовать. Это означает, что у нас ничего не будет из стандартного набора, и мы должы будет реализовать их самостоятельно. Тем не менее, у нас будут некоторые заголовочные файлы, которые являются частью компилятора, а не стандарта C.")]),t._v(" "),a("p",[t._v("Среди них:")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("stdbool.h")]),t._v(" - тип для булевых (логических) значений;")]),t._v(" "),a("li",[a("code",[t._v("stddef.h")]),t._v(" - "),a("code",[t._v("size_t")]),t._v(" и "),a("code",[t._v("NULL")]),t._v(";")]),t._v(" "),a("li",[a("code",[t._v("stdint.h")]),t._v(" - "),a("code",[t._v("intx_t")]),t._v(" и "),a("code",[t._v("uintx_t")]),t._v(" для точных размеров переменных (если вы использовали "),a("code",[t._v("short")]),t._v(" вместо "),a("code",[t._v("uint16_t")]),t._v(", то при изменении размера типа всё может неожиданно сломаться;")]),t._v(" "),a("li",[a("code",[t._v("float.h")]),t._v(", "),a("code",[t._v("iso646.h")]),t._v(", "),a("code",[t._v("limits.h")]),t._v(", и "),a("code",[t._v("stdarg.h")]),t._v(".")])]),t._v(" "),a("h3",{attrs:{id:"пищем-ядро-на-c"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#пищем-ядро-на-c"}},[t._v("#")]),t._v(" Пищем ядро на C")]),t._v(" "),a("p",[t._v("Для начала мы напишем простое ядро, которое будет использовать текстовый режим VGA (адрес "),a("code",[t._v("0xB8000")]),t._v("). Оно будет запоминать положение следущего символа в буффере и выводить простые симфолы, но буде поддержки переноса строк. Добавление поддержки этой функции может стать вашей первой самостоятельной задачей. Потратьте немного времени, чтобы понять собственный код.")]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("Важно!")]),t._v(" "),a("p",[t._v("Текстовый режим (также как и BIOS) является устаревшим на новых устройствах, т. к. UEFI поддерживает только буффер пикселей. Для будущей совместимости вы можете начать с этого. Просим загрузчик настроить графический буффер соответствующим флагом мультизагрузки, либо самостоятельно используем вызовы VESA VBE. В отличии от текстового режима VGA, буффер имеет пиксели, что озачает ручную отрисовку каждого символа, поддержку пролистывания (скролла), перемещения курсока и т. д. Также значит, что вам потребуется другой "),a("code",[t._v("terminal_putchar")]),t._v(" и шрифт (изображения для каждого символа). Все дистрибутивы Linux поставляют экранные шрифты ("),a("em",[t._v("англ.")]),t._v(" PC Screen Fonts), которые вы можете использовать.")])]),t._v(" "),a("div",{staticClass:"language-c extra-class"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("<stdbool.h>")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("<stddef.h>")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("<stdint.h>")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Проверяем, что используется привильное нацеливание сборки. */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("defined")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__linux__"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("error")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Вы не используете кросс-компилятор, скорее всего это приведёт к проблемам"')])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("endif")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("defined")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__i386__"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("error")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Данный пример будет работать только с компилятором ix86-elf"')])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("endif")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Констатны цветов для текстового режима. */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("enum")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("vga_color")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    VGA_COLOR_BLACK "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    VGA_COLOR_BLUE "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    VGA_COLOR_GREEN "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    VGA_COLOR_CYAN "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    VGA_COLOR_RED "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    VGA_COLOR_MAGENTA "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    VGA_COLOR_BROWN "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    VGA_COLOR_LIGHT_GREY "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    VGA_COLOR_DARK_GREY "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    VGA_COLOR_LIGHT_BLUE "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    VGA_COLOR_LIGHT_GREEN "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    VGA_COLOR_LIGHT_CYAN "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    VGA_COLOR_LIGHT_RED "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    VGA_COLOR_LIGHT_MAGENTA "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    VGA_COLOR_LIGHT_BROWN "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    VGA_COLOR_WHITE "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("inline")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint8_t")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vga_entry_color")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("enum")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("vga_color")]),t._v(" fg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("enum")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("vga_color")]),t._v(" bg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" fg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" bg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("inline")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vga_entry")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" uc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint8_t")]),t._v(" color"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" uc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" color "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("size_t")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("strlen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("size_t")]),t._v(" len "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("len"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" len"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" len"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("size_t")]),t._v(" VGA_WIDTH "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("size_t")]),t._v(" VGA_HEIGHT "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("size_t")]),t._v(" terminal_row"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("size_t")]),t._v(" terminal_column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint8_t")]),t._v(" terminal_color"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" terminal_buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("terminal_initialize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    terminal_row "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    terminal_column "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    terminal_color "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vga_entry_color")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("VGA_COLOR_LIGHT_GREY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" VGA_COLOR_BLACK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    terminal_buffer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0xB8000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("size_t")]),t._v(" y "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" y "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" VGA_HEIGHT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" y"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("size_t")]),t._v(" x "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" x "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" VGA_WIDTH"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" x"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("size_t")]),t._v(" index "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" y "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" VGA_WIDTH "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            terminal_buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vga_entry")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("' '")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" terminal_color"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("terminal_setcolor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint8_t")]),t._v(" color"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    terminal_color "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" color"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("terminal_putentryat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint8_t")]),t._v(" color"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("size_t")]),t._v(" x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("size_t")]),t._v(" y"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("size_t")]),t._v(" index "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" y "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" VGA_WIDTH "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    terminal_buffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vga_entry")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" color"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("terminal_putchar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("terminal_putentryat")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" terminal_color"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" terminal_column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" terminal_row"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("terminal_column "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" VGA_WIDTH"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        terminal_column "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("terminal_row "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" VGA_HEIGHT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            terminal_row "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("terminal_write")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("size_t")]),t._v(" size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("size_t")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("terminal_putchar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("terminal_write_string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("terminal_write")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("strlen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("kernel_main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("terminal_initialize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("terminal_write_string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello, kernel World!\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Обратите внимание, что в коде мы хотели использовать обычную функцию C "),a("code",[t._v("strlen")]),t._v(", которая является частью стандартной библиотеки C, которой у вас нет. Вместо этого мы положились на отдельный заголовок "),a("code",[t._v("stddef.h")]),t._v(", и собственную реализацию. И так вам придётся делать с каждой функцией из стандартной библиотеки, которую захотите использовать (заголовки для отдельной среды предоставляют только типы данным и макросы).")]),t._v(" "),a("p",[t._v("Пример выше можно собрать, выполнив:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("i686-elf-gcc -c kernel.c -o kernel.o -std"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("gnu99 -ffreestanding -O2 -Wall -Wextra\n")])])]),a("p",[t._v("Заметим, что код примера использует некоторый функционал из сборщика GNU для C99.")]),t._v(" "),a("h3",{attrs:{id:"пишем-ядро-на-c"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#пишем-ядро-на-c"}},[t._v("#")]),t._v(" Пишем ядро на C++")]),t._v(" "),a("p",[t._v("Написать ядро на C++ легко, но стоит помнить, что не весь функционал языка доступен. К примеру, выбрасывание исключений требует особой поддержи в среде выполнения, а также выделений памяти. В нашем случае просто добавляется "),a("code",[t._v('extern "C"')]),t._v(" для главной функции. Важно, чтобы функция "),a("code",[t._v("kernel_main")]),t._v(" была объявлена как видимостью для C, иначе компилятор добавит информацию в название сборки ("),a("em",[t._v("англ.")]),t._v(" assembly). Это делает невозможным вызов этой функции из ассеблера.")]),t._v(" "),a("p",[t._v("Сохраните всё в файл "),a("code",[t._v("kernel.cpp")]),t._v(" (или с вашим любимым расширением файла с кодом на C++).\nВы можете скомпилировать этот файл, используя:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("i686-elf-g++ -c kernel.cpp -o kernel.o -ffreestanding -O2 -Wall -Wextra -fno-exceptions -fno-rtti\n")])])]),t._v(" "),a("h2",{attrs:{id:"компоновка-ядра"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#компоновка-ядра"}},[t._v("#")]),t._v(" Компоновка ядра")]),t._v(" "),a("p",[t._v("Выше упомянутые "),a("code",[t._v("boot.s")]),t._v(" и "),a("code",[t._v("kernel.c")]),t._v(" содержат части нашего ядра, и для создания полноценного ядра остаётся только скомпоновать их собранные версии в программу ядра, которую загрузчик сможет использовать. При сборке пользовательских программ мы используем стандартные скрипты компоновки инструментов разработки. В нашем случае нужно написать собственный скрипт. Ниже пример "),a("code",[t._v("linker.ld")]),t._v(":")]),t._v(" "),a("div",{staticClass:"language-ld extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('/* Загрузчик начнёт выполение с этой метки, назначенной точкой входа. */\nENTRY(_start)\n\n/* Сообщаем о различных секциях, которые содержатся с объектных файлах конечного ядра. */\nSECTIONS {\n    /* Инструкции будут размещены в первом 1 МБ, т. е. месте, принятом для расположения\n       ядер, загружаемых через загрузчик. */\n    . = 1M;\n\n    /*\n    Первым должен идти заголовок мультизагрузочности, иначе загрузчик не распознает\n    формат файла. Далее идёт секция ".text".\n    */\n    .text BLOCK(4K) : ALIGN(4K) {\n        *(.multiboot)\n        *(.text)\n    }\n\n    /* Секция только для чтения. */\n    .rodata BLOCK(4K) : ALIGN(4K) {\n        *(.rodata)\n    }\n\n    /* Инициализированная секция данных */\n    .data BLOCK(4K) : ALIGN(4K) {\n        *(.data)\n    }\n\n    /* Неинициализированные перезаписываемые данные и стек */\n    .bss BLOCK(4K) : ALIGN(4K) {\n        *(COMMON)\n        *(.bss)\n    }\n\n    /*\n    Компилятор может пораждать другие секции, по умолчанию они будут находиться в\n    сегменте с таким же названием. Просто добавьте здесь, если требуется.\n    */\n}\n')])])]),a("p",[t._v("Мы используем компилятор в качестве компоновщика из-за большего контроля процесса. Не забудьте, что если вы использовали C++ при написании ядра, то нужно будет использовать компилятор для C++.")]),t._v(" "),a("p",[t._v("Вы можете скомпоновать ядро командой ниже:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("i686-elf-gcc -T linker.ld -o my_kernel.bin -ffreestanding -O2 -nostdlib boot.o kernel.o -lgcc\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("Заметка")]),t._v(" "),a("p",[t._v("Некоторые туториалы предлагаю использовать "),a("code",[t._v("i686-elf-ld")]),t._v(" вместо компилятор\nNote: Some tutorials suggest linking with i686-elf-ld rather than the compiler, но это не позволяет выполнять компилятору некоторые задачи во время компоновки.")])]),t._v(" "),a("p",[t._v("Теперь файл "),a("code",[t._v("my_kernel.bin")]),t._v(" - ваше ядро (другие файлы более не нужны)!\nThe file myos.bin is now your kernel (all other files are no longer needed). Note that we are linking against libgcc, which implements various runtime routines that your cross-compiler depends on. Leaving it out will give you problems in the future. If you did not build and install libgcc as part of your cross-compiler, you should go back now and build a cross-compiler with libgcc. The compiler depends on this library and will use it regardless of whether you provide it or not.")]),t._v(" "),a("h2",{attrs:{id:"проверяем-ядро"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#проверяем-ядро"}},[t._v("#")]),t._v(" Проверяем ядро")]),t._v(" "),a("h3",{attrs:{id:"проверка-мультизагрузочности"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#проверка-мультизагрузочности"}},[t._v("#")]),t._v(" Проверка мультизагрузочности")]),t._v(" "),a("p",[t._v("Проверить присутствие заголовка мультизагрузочности v1 можно при помощи GRUB:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("grub-file --is-x86-multiboot myos.bin\n")])])]),a("p",[t._v("Важно, чтобы заголовок находился в первых 8 КиБ с выравнивание в 4 байта, иначе GRUB выйдет с кодом 1. Поверка v2 заголовка проводится с аргументом "),a("code",[t._v("--is-x86-multiboot2")]),t._v(". Чтобы не проверять возвращаемый код, можно использовать sh-скрипт:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" grub-file --is-x86-multiboot "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Мультизагрузочный заголовок найден"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Образ не содержит мультизагрузочный заголовок"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fi")]),t._v("\n")])])]),a("h3",{attrs:{id:"сборка-загрузочного-cd-rom-образа"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#сборка-загрузочного-cd-rom-образа"}},[t._v("#")]),t._v(" Сборка загрузочного CD-ROM образа")]),t._v(" "),a("p",[t._v("Для начала нужно создать файл "),a("code",[t._v("boot/grub/grub.cfg")]),t._v(" в папке "),a("code",[t._v("isodir")]),t._v(", который будет хранить загрузочную конфигурацию:")]),t._v(" "),a("div",{staticClass:"language-txt extra-class"},[a("pre",{pre:!0,attrs:{class:"language-txt"}},[a("code",[t._v('menuentry "Boot MyOS" {\n    multiboot /boot/myos.bin\n}\n')])])]),a("p",[t._v("Далее переместим скомпилированное ядро "),a("code",[t._v("myos.bin")]),t._v(" в "),a("code",[t._v("isodir/boot")]),t._v(" и соберём сам образ:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("grub-mkrescue -o myos.iso isodir\n")])])]),a("h3",{attrs:{id:"тестовыи-запуск"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#тестовыи-запуск"}},[t._v("#")]),t._v(" Тестовый запуск")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("qemu-system-i386 -cdrom myos.iso\n")])])]),a("p",[t._v('После загрузки вы, скорее всего, увидите "Hello, kernel World!".')]),t._v(" "),a("p",[t._v("Дополнительно, QEMU поддерживает прямую загрузку ядра без загрузочного образа:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("qemu-system-i386 -kernel myos.bin\n")])])]),a("h2",{attrs:{id:"что-дальше"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#что-дальше"}},[t._v("#")]),t._v(" Что дальше?")]),t._v(" "),a("p",[t._v("Только что на свет появилась ещё одна ОС, поздравляем! Но это только начало. Вот что вы можете сделать:")]),t._v(" "),a("h3",{attrs:{id:"поддержка-переносов-строки-в-драивер-терминала"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#поддержка-переносов-строки-в-драивер-терминала"}},[t._v("#")]),t._v(" Поддержка переносов строки в драйвер терминала")]),t._v(" "),a("p",[t._v("Текстовый режим VGA на месте "),a("code",[t._v("\\n")]),t._v(" хранит другой символ, поэтому следует добавить проверку в "),a("code",[t._v("terminal_putchar")]),t._v(", которая будет увелимивать "),a("code",[t._v("terminal_row")]),t._v(" и сбрасывать "),a("code",[t._v("terminal_column")]),t._v(".")]),t._v(" "),a("h3",{attrs:{id:"пролистывание-терминала"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#пролистывание-терминала"}},[t._v("#")]),t._v(" Пролистывание терминала")]),t._v(" "),a("p",[t._v("Сейчас, если мы достигаем конца экрана, то следующим символом просто оказываемя в его начале. Вместе этого следует сдвигать строки вверх, оставляя одну строку для ввода символов.")]),t._v(" "),a("h3",{attrs:{id:"цветные-ascii-арты"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#цветные-ascii-арты"}},[t._v("#")]),t._v(" Цветные ASCII-арты")]),t._v(" "),a("p",[t._v("Текущий терминальный драйвер поддерживает только 16 цветов (из них 8 фоновых), поэтому вам понадобится нормальный VGA драйвер.")]),t._v(" "),a("h3",{attrs:{id:"глобальные-конструкторы"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#глобальные-конструкторы"}},[t._v("#")]),t._v(" Глобальные конструкторы")]),t._v(" "),a("p",[t._v("This tutorial showed a small example of how to create a minimal environment for C and C++ kernels. Unfortunately, you don't have everything set up yet. For instance, C++ with global objects will not have their constructors called because you never do it. The compiler uses a special mechanism for performing tasks at program initialization time through the "),a("code",[t._v("crt*.o")]),t._v(" objects, which may be valuable even for C programmers. If you combine the "),a("code",[t._v("crt*.o")]),t._v(" files correctly, you will create an "),a("code",[t._v("_init")]),t._v(" function that invokes all the program initialization tasks. Your "),a("code",[t._v("boot.o")]),t._v(" object file can then invoke "),a("code",[t._v("_init")]),t._v(" before calling "),a("code",[t._v("kernel_main")]),t._v(".")]),t._v(" "),a("h3",{attrs:{id:"организация-ос"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#организация-ос"}},[t._v("#")]),t._v(" Организация ОС")]),t._v(" "),a("p",[a("strong",[t._v("Главная статья")]),t._v(": "),a("RouterLink",{attrs:{to:"/intro/skeleton.html"}},[t._v("Пример организации ОС")])],1),t._v(" "),a("p",[t._v("Этот туториал покажет как нетерпеливому новичку получить приветствие от своей ОС. В нём не будет лучших практик организации ОС, однако вы узнаете как сделать ОС с ядром, стандартной библиотекой и подготовленным пространством для пользователя.")]),t._v(" "),a("h3",{attrs:{id:"дальнеишее-изучение"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#дальнеишее-изучение"}},[t._v("#")]),t._v(" Дальнейшее изучение")]),t._v(" "),a("h2",{attrs:{id:"частые-вопросы"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#частые-вопросы"}},[t._v("#")]),t._v(" Частые вопросы")]),t._v(" "),a("h3",{attrs:{id:"почему-используется-мультизагрузочныи-заголовок-разве-grub-не-умеет-работать-с-elf"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#почему-используется-мультизагрузочныи-заголовок-разве-grub-не-умеет-работать-с-elf"}},[t._v("#")]),t._v(" Почему используется мультизагрузочный заголовок? Разве GRUB не умеет работать с ELF?")]),t._v(" "),a("p",[t._v("GRUB может загружать множество разных форматов. Однако, этот туториал описывает создание ядра, сомвестимого со стандартам мультизагрузочности, что означает поддержку и другимим загрузчиками.")]),t._v(" "),a("h3",{attrs:{id:"grub-очищает-секцию-bss-перед-загрузкои-ядра"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#grub-очищает-секцию-bss-перед-загрузкои-ядра"}},[t._v("#")]),t._v(" GRUB очищает секцию BSS перед загрузкой ядра?")]),t._v(" "),a("p",[t._v("Да. Для ELF секция .bss автоматически определяется и очищается (хотя в стандарте мультизагрузочности нет чётких указаний). Для других форматов вы можете использовать флаг №16 мультизагрузочного заголовка и не нулевое значение для поля "),a("code",[t._v("bss_end_addr")]),t._v(".")]),t._v(" "),a("h3",{attrs:{id:"grub-error-13-invalid-or-unsupported-executable-format"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#grub-error-13-invalid-or-unsupported-executable-format"}},[t._v("#")]),t._v(" [GRUB] Error 13: Invalid or unsupported executable format")]),t._v(" "),a("p",[t._v('Chances are the Multiboot header is missing from the final executable, or it is not at the right location.\nIf you are using some other format than ELF (such as PE), you should specify the AOUT kludge in the Multiboot header. The grub-file program describe aboveand "objdump -h" should give you more hints about what is going on.\nIt may also happen if you use an ELF object file instead of an executable (e.g. you have an ELF file with unresolved symbols or unfixable relocations). Try to link your ELF file to a binary executable to get more accurate error messages.\nA common problem when your kernel size increases, is that the Multiboot header does no longer appear at the start of the output binary. The common solutions is to put the Multiboot header in a separate section and make sure that section is first in the output binary, or to include the Multiboot header itself in the linker script.')]),t._v(" "),a("h3",{attrs:{id:"qemu-could-not-read-from-cd-rom-code-0009"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#qemu-could-not-read-from-cd-rom-code-0009"}},[t._v("#")]),t._v(" [QEMU] Could not read from CD-ROM (code 0009)")]),t._v(" "),a("p",[t._v("If your development system is booted from EFI it may be that you don't have the PC-BIOS version of the grub binaries installed anywhere. If you install them then grub-mkrescue will by default produce a hybrid ISO that will work in QEMU. On Ubuntu this can be achieved with: apt-get install grub-pc-bin.")])])}),[],!1,null,null,null);s.default=e.exports}}]);